<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2018-02-27 13:51:00 +0000">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Introduction to High-Performance Computing: Using resources effectively</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../00-hpc-intro/">What is High Performance Computing?</a></li>
            
            <li><a href="../01-connecting/">Connecting to the cluster</a></li>
            
            <li><a href="../02-navigation/">Moving around and looking at things</a></li>
            
            <li><a href="../03-files/">Writing and reading files</a></li>
            
            <li><a href="../04-wildcards-pipes/">Wildcards and pipes</a></li>
            
            <li><a href="../05-scripts/">Scripts, variables, and loops</a></li>
            
            <li><a href="../11-cluster/">Working on a cluster</a></li>
            
            <li><a href="../12-scheduler/">Scheduling jobs</a></li>
            
            <li><a href="../13-modules/">Accessing software</a></li>
            
            <li><a href="../14-transferring-files/">Transferring files</a></li>
            
            <li><a href="../15-resources/">Using resources effectively</a></li>
            
            <li><a href="../16-responsiblity/">Using resources effectively</a></li>
            
            <li><a href="../17-hpc-fundamentals/">HPC Fundamentals</a></li>
            
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference/">Reference</a></li>
            
            <li><a href="../about/">About</a></li>
            
            <li><a href="../discuss/">Discussion</a></li>
            
            <li><a href="../figures/">Figures</a></li>
            
            <li><a href="../guide/">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
	
	<li><a href="/edit/gh-pages/_episodes/15-resources.md">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../14-transferring-files/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">Introduction to High-Performance Computing</a></h3>
    <h1 class="maintitle">Using resources effectively</h1>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../16-responsiblity/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 15 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do we monitor our jobs?</p>
</li>
	
	<li><p>How can I get my jobs scheduled more easily?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Understand how to look up job statistics and profile code.</p>
</li>
	
	<li><p>Understand job size implications.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>We now know virtually everything we need to know about getting stuff on a cluster.
We can log on, submit different types of jobs, use preinstalled software, 
and install and use software of our own.
What we need to do now is use the systems effectively.</p>

<h2 id="estimating-required-resources-using-the-scheduler">Estimating required resources using the scheduler</h2>

<p>Although we covered requesting resources from the scheduler earlier,
how do we know how much and what type of resources we will need in the first place?</p>

<p>Answer: we don’t. 
Not until we’ve tried it ourselves at least once.
We’ll need to benchmark our job and experiment with it before
we know how much it needs in the way of resources.</p>

<p>The most effective way of figuring out how much resources a job needs is to submit a test job,
and then ask the scheduler how many resources it used.
A good rule of thumb is to ask the scheduler for more time and memory than your job can use.
This value is typically two to three times what you think your job will need.</p>

<blockquote class="challenge">
  <h2 id="benchmarking-fastqc">Benchmarking <code class="highlighter-rouge">fastqc</code></h2>
  <p>Create a job that runs the following command 
in the same directory as <code class="highlighter-rouge">.fastq</code> files</p>

  <div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fastqc name_of_fastq_file
</code></pre></div>  </div>

  <p>The <code class="highlighter-rouge">fastqc</code> command is provided by the <code class="highlighter-rouge">fastqc</code> module.
You’ll need to figure out a good amount of resources to ask for for this first “test run”.
You might also want to have the scheduler email you to tell you when the job is done.</p>

  <p>Hint: the job only needs 1 cpu and not too much memory or time.
 The trick is figuring out just how much you’ll need!</p>
</blockquote>

<p>Once the job completes (note that it takes much less time than expected),
we can query the scheduler to see how long our job took and what resources were used.
We will use <code class="highlighter-rouge">sacct</code> to get statistics about our job.</p>

<p>By itself, <code class="highlighter-rouge">sacct -u yourUsername</code> shows all commands that we ran 
since midnight on the previous day 
(we can change this behavior with the <code class="highlighter-rouge">--start-time</code> option).</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[remote]$ sacct -u yourUsername
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      JobID    JobName  Partition    Account  AllocCPUS      State ExitCode 
------------ ---------- ---------- ---------- ---------- ---------- -------- 
1964               bash   standard    default          1  COMPLETED      0:0 
1964.extern      extern               default          1  COMPLETED      0:0 
1964.0             bash               default          1  COMPLETED      0:0 
1965         build-ind+ summer-sc+    default          1  COMPLETED      0:0 
1965.batch        batch               default          1  COMPLETED      0:0 
1965.extern      extern               default          1  COMPLETED      0:0 
</code></pre></div></div>

<p>This shows all the jobs we ran recently 
(note that there are multiple entries per job).
To get detailed info about a job, 
we change our <code class="highlighter-rouge">sacct</code> command slightly
(<code class="highlighter-rouge">-j</code> corresponds to job id).</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[remote]$ sacct -j 1965 -l
</code></pre></div></div>

<p>It will show a ton of info, in fact, every single piece of info
collected on your job by the scheduler.
It may be useful to redirect this information to <code class="highlighter-rouge">less</code> to make it easier to view (use the left and right arrow keys to scroll through fields).</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[remote]$ sacct -j 1965 -l | less
</code></pre></div></div>

<p>Some interesting fields include the following:</p>

<ul>
  <li><strong>Hostname</strong> - Where did your job run?</li>
  <li><strong>MaxRSS</strong> - What was the maximum amount of memory used?</li>
  <li><strong>Elapsed</strong> - How long did the job take?</li>
  <li><strong>State</strong> - What is the job currently doing/what happened to it?</li>
  <li><strong>MaxDiskRead</strong> - Amount of data read from disk.</li>
  <li><strong>MaxDiskWrite</strong> - Amount of data written to disk.</li>
</ul>

<h2 id="measuring-the-statistics-of-currently-running-tasks">Measuring the statistics of currently running tasks</h2>

<p>One very useful feature of SLURM is the ability to SSH 
to a node where a job is running and check how it’s doing.
To do this, check where a job is running with <code class="highlighter-rouge">squeue</code>,
then run <code class="highlighter-rouge">ssh nodename</code>.</p>

<p>However, we can also check on stuff running on the login node right now the same way
(so it’s not necessary to <code class="highlighter-rouge">ssh</code> to a node for this example).</p>

<h3 id="top">top</h3>

<p>The best way to check current system stats is with <code class="highlighter-rouge">top</code>
(<code class="highlighter-rouge">htop</code> is a prettier version of <code class="highlighter-rouge">top</code> but may not be available on your system).</p>

<p>Some sample output from my laptop might look like the following (<code class="highlighter-rouge">ctrl + c</code> to exit):</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>top
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>top - 21:00:19 up  3:07,  1 user,  load average: 1.06, 1.05, 0.96
Tasks: 311 total,   1 running, 222 sleeping,   0 stopped,   0 zombie
%Cpu(s):  7.2 us,  3.2 sy,  0.0 ni, 89.0 id,  0.0 wa,  0.2 hi,  0.2 si,  0.0 st
KiB Mem : 16303428 total,  8454704 free,  3194668 used,  4654056 buff/cache
KiB Swap:  8220668 total,  8220668 free,        0 used. 11628168 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 1693 jeff      20   0 4270580 346944 171372 S  29.8  2.1   9:31.89 gnome-shell
 3140 jeff      20   0 3142044 928972 389716 S  27.5  5.7  13:30.29 Web Content
 3057 jeff      20   0 3115900 521368 231288 S  18.9  3.2  10:27.71 firefox
 6007 jeff      20   0  813992 112336  75592 S   4.3  0.7   0:28.25 tilix
 1742 jeff      20   0  975080 164508 130624 S   2.0  1.0   3:29.83 Xwayland
    1 root      20   0  230484  11924   7544 S   0.3  0.1   0:06.08 systemd    
   68 root      20   0       0      0      0 I   0.3  0.0   0:01.25 kworker/4:1   
 2913 jeff      20   0  965620  47892  37432 S   0.3  0.3   0:11.76 code
    2 root      20   0       0      0      0 S   0.0  0.0   0:00.02 kthreadd
</code></pre></div></div>

<p>Overview of the most important fields:</p>

<ul>
  <li><code class="highlighter-rouge">PID</code> - What is the numerical id of each process?</li>
  <li><code class="highlighter-rouge">USER</code> - Who started the process?</li>
  <li><code class="highlighter-rouge">RES</code> - What is the amount of memory currently being used by a process (in bytes)?</li>
  <li><code class="highlighter-rouge">%CPU</code> - How much of a CPU is each process using? Values higher than 100 percent indicate that a process is running in parallel.</li>
  <li><code class="highlighter-rouge">%MEM</code> - What percent of system memory is a process using?</li>
  <li><code class="highlighter-rouge">TIME+</code> - How much CPU time has a process used so far? Processes using 2 CPUs accumulate time at twice the normal rate.</li>
  <li><code class="highlighter-rouge">COMMAND</code> - What command was used to launch a process?</li>
</ul>

<h3 id="free">free</h3>

<p>Another useful tool is the <code class="highlighter-rouge">free -h</code> command. 
This will show the currently used/free amount of memory.</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ free -h
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              total        used        free      shared  buff/cache   available
Mem:           3.8G        1.5G        678M        327M        1.6G        1.6G
Swap:          3.9G        170M        3.7G
</code></pre></div></div>

<p>The key fields here are total, used, and available - which represent the amount of memory
that the machine has in total, how much is currently being used, and how much is still available.
When a computer runs out of memory it will attempt to use “swap” space on your hard drive instead. 
Swap space is very slow to access - a computer may appear to “freeze” if it runs out of memory and 
begins using swap.</p>

<h3 id="ps">ps</h3>

<p>To show all processes from your current session, type <code class="highlighter-rouge">ps</code>.</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  PID TTY          TIME CMD
15113 pts/5    00:00:00 bash
15218 pts/5    00:00:00 ps
</code></pre></div></div>

<p>Note that this will only show processes from our current session. 
To show all processes you own 
(regardless of whether they are part of your current session or not), 
you can use <code class="highlighter-rouge">ps -ef</code> and <code class="highlighter-rouge">grep</code> for your username.</p>

<div class="bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ps -ef | grep yourUsername
</code></pre></div></div>
<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jeff      1594     1  0 14:23 ?        00:00:00 /usr/lib/systemd/systemd --user
jeff      1599  1594  0 14:23 ?        00:00:00 (sd-pam)
jeff      1610     1  0 14:23 ?        00:00:01 /usr/bin/gnome-keyring-daemon --daemonize --login
jeff      1627  1586  0 14:23 tty2     00:00:00 /usr/libexec/gdm-wayland-session gnome-session
jeff      1629  1594  0 14:23 ?        00:00:01 /usr/bin/dbus-daemon --session --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only
jeff      1632  1627  0 14:23 tty2     00:00:00 /usr/libexec/gnome-session-binary
jeff      1692  1594  0 14:23 ?        00:00:00 /usr/libexec/gvfsd
</code></pre></div></div>

<p>This is useful for identifying which processes are doing what.</p>

<h2 id="killing-processes">Killing processes</h2>

<p>To kill all of a certain type of process, you can run <code class="highlighter-rouge">killall commandName</code>.
<code class="highlighter-rouge">killall rsession</code> would kill all <code class="highlighter-rouge">rsession</code> processes created by RStudio,
for instance.
Note that you can only kill your own processes.</p>

<p>You can also kill processes by their PIDs using <code class="highlighter-rouge">kill 1234</code> where <code class="highlighter-rouge">1234</code> is a <code class="highlighter-rouge">PID</code>.
Sometimes however, killing a process does not work instantly.
To kill the process in the most hardcore manner possible, use the <code class="highlighter-rouge">-9</code> flag.
It’s recommended to kill using without <code class="highlighter-rouge">-9</code> first.
This gives a process the chance to clean up child processes, and exit cleanly.
However, if a process just isn’t responding, use <code class="highlighter-rouge">-9</code> to kill it instantly.</p>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>The smaller your job, the faster it will schedule.</p>
</li>
    
  </ul>
</blockquote>


<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../14-transferring-files/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../16-responsiblity/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      
<footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016–2018
	
	<a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	
	<a href="/edit/gh-pages/_episodes/15-resources.md">Edit on GitHub</a>
	
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CITATION">Cite</a>
	/
	<a href="mailto:lessons@software-carpentry.org">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
